name: portnox-ztna-multi-idp

# ZTNA Lab with Multiple Identity Providers
# Demonstrates ZTNA integration with Azure AD, Okta, Google Workspace, and OneLogin
# Uses Keycloak containers to simulate different IDP providers

topology:
  nodes:
    # Portnox ZTNA Gateway
    ztna-gateway:
      kind: linux
      image: portnox/portnox-ztna-gateway:latest
      env:
        PORTNOX_CLOUD_URL: ${PORTNOX_CLOUD_URL:-https://yourorg.portnox.cloud}
        PORTNOX_GATEWAY_TOKEN: ${PORTNOX_GATEWAY_TOKEN:-your-ztna-gateway-token}
        PORTNOX_ORG_ID: ${PORTNOX_ORG_ID:-your-org-id}
        # Multi-IDP support
        ENABLE_AZURE_AD: ${ENABLE_AZURE_AD:-true}
        ENABLE_OKTA: ${ENABLE_OKTA:-true}
        ENABLE_GOOGLE: ${ENABLE_GOOGLE:-true}
        ENABLE_ONELOGIN: ${ENABLE_ONELOGIN:-true}
      ports:
        - "443:443/tcp"
        - "8443:8443/tcp"
      mgmt-ipv4-address: 172.20.20.10/24
    
    # Azure AD Simulator (Keycloak configured as Azure AD)
    idp-azure-ad:
      kind: linux
      image: quay.io/keycloak/keycloak:latest
      env:
        KEYCLOAK_ADMIN: admin
        KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_PASSWORD:-admin123}
        KC_HOSTNAME: idp-azure-ad
        KC_HTTP_PORT: 8080
      ports:
        - "8081:8080/tcp"
      mgmt-ipv4-address: 172.20.20.20/24
      exec:
        - /opt/keycloak/bin/kc.sh start-dev
    
    # Okta Simulator (Keycloak configured as Okta)
    idp-okta:
      kind: linux
      image: quay.io/keycloak/keycloak:latest
      env:
        KEYCLOAK_ADMIN: admin
        KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_PASSWORD:-admin123}
        KC_HOSTNAME: idp-okta
        KC_HTTP_PORT: 8080
      ports:
        - "8082:8080/tcp"
      mgmt-ipv4-address: 172.20.20.21/24
      exec:
        - /opt/keycloak/bin/kc.sh start-dev
    
    # Google Workspace Simulator (Keycloak configured as Google)
    idp-google:
      kind: linux
      image: quay.io/keycloak/keycloak:latest
      env:
        KEYCLOAK_ADMIN: admin
        KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_PASSWORD:-admin123}
        KC_HOSTNAME: idp-google
        KC_HTTP_PORT: 8080
      ports:
        - "8083:8080/tcp"
      mgmt-ipv4-address: 172.20.20.22/24
      exec:
        - /opt/keycloak/bin/kc.sh start-dev
    
    # OneLogin Simulator (Keycloak configured as OneLogin)
    idp-onelogin:
      kind: linux
      image: quay.io/keycloak/keycloak:latest
      env:
        KEYCLOAK_ADMIN: admin
        KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_PASSWORD:-admin123}
        KC_HOSTNAME: idp-onelogin
        KC_HTTP_PORT: 8080
      ports:
        - "8084:8080/tcp"
      mgmt-ipv4-address: 172.20.20.23/24
      exec:
        - /opt/keycloak/bin/kc.sh start-dev
    
    # Protected Application: Corporate Web App (Azure AD auth)
    app-corporate:
      kind: linux
      image: nginx:latest
      mgmt-ipv4-address: 172.20.20.30/24
      ports:
        - "8090:80/tcp"
    
    # Protected Application: SaaS App (Okta auth)
    app-saas:
      kind: linux
      image: nginx:latest
      mgmt-ipv4-address: 172.20.20.31/24
      ports:
        - "8091:80/tcp"
    
    # Protected Application: Cloud Storage (Google auth)
    app-storage:
      kind: linux
      image: nginx:latest
      mgmt-ipv4-address: 172.20.20.32/24
      ports:
        - "8092:80/tcp"
    
    # Protected Application: HR System (OneLogin auth)
    app-hr:
      kind: linux
      image: nginx:latest
      mgmt-ipv4-address: 172.20.20.33/24
      ports:
        - "8093:80/tcp"
    
    # Test Clients
    client-azure:
      kind: linux
      image: wbitt/network-multitool:latest
      mgmt-ipv4-address: 172.20.20.40/24
    
    client-okta:
      kind: linux
      image: wbitt/network-multitool:latest
      mgmt-ipv4-address: 172.20.20.41/24
    
    client-google:
      kind: linux
      image: wbitt/network-multitool:latest
      mgmt-ipv4-address: 172.20.20.42/24
    
    client-onelogin:
      kind: linux
      image: wbitt/network-multitool:latest
      mgmt-ipv4-address: 172.20.20.43/24

  links:
    # ZTNA Gateway to IDPs
    - endpoints: ["ztna-gateway:eth1", "idp-azure-ad:eth1"]
    - endpoints: ["ztna-gateway:eth2", "idp-okta:eth1"]
    - endpoints: ["ztna-gateway:eth3", "idp-google:eth1"]
    - endpoints: ["ztna-gateway:eth4", "idp-onelogin:eth1"]
    
    # ZTNA Gateway to Apps
    - endpoints: ["ztna-gateway:eth5", "app-corporate:eth1"]
    - endpoints: ["ztna-gateway:eth6", "app-saas:eth1"]
    - endpoints: ["ztna-gateway:eth7", "app-storage:eth1"]
    - endpoints: ["ztna-gateway:eth8", "app-hr:eth1"]
